Finding the correct solution was not too hard. The challenge is to implement it efficiently. Somehow, the time measurement is inconsistent for this problem on Kattis, so it's hard to know if your optimizations are working.

Might continue to tinker with this solution later.